---
title: "Plot All Storms"
author: "Steve Walsh"
date: "1/13/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sp)
library(raster)
library(ncdf4)
library(sf)
library(dplyr)
library(stringr) #str_locate_all "_218_" in the NAM file names

# install.packages("rgdal", type = "source", configure.args="--with-gdal-config=/Library/Frameworks/GDAL.framework/unix/bin/gdal-config --with-proj-include=/Library/Frameworks/PROJ.framework/unix/include --with-proj-lib=/Library/Frameworks/PROJ.framework/unix/lib --with-proj-share=/Library/Frameworks/PROJ.framework/unix/share/proj --with-proj-data=/Library/Frameworks/PROJ.framework/unix/share/proj --with-data-copy=yes")
```

Plotting 39 Storms' Precipitation for First 24 Hours After Landfall

```{r plot.all.41}
all.storm.folders <- list.dirs("NAMandST4", recursive = F) #G:\\NAMandST4
NAMlist <- list()
ST4list <- list()
mask <- raster("G:\\lsmask.nc")
mask[mask==-1] <- 0
extent(mask)[1] <- extent(mask)[1]-360
extent(mask)[2] <- extent(mask)[2]-360
mask.regrid <- resample(mask, projectRaster(raster("G:\\nam_218_20050829_1200_f012.grib"),crs = "+proj=longlat +datum=WGS84"), method='ngb')


for(i in 1:length(all.storm.folders)){
  # [-c(15:36)],[c(1:16,35:39)] right after all.storm.folders to use only the ones without jpeg2000 issue
  # i <- 1
  print(i)
  currentST4_NAM_folders <- list.dirs(all.storm.folders[i])[-1] #uncomment the [-1] when st4 and nam folders are together
  ST4_folder <- currentST4_NAM_folders[1]
  NAM_folder <- currentST4_NAM_folders[2] #uncomment the [2] as well
  
  print(length(list.files(NAM_folder)))
  #print(list.files(NAM_folder))
  NAMlist[[i]] <- list()
  ST4list[[i]] <- list()
  if(length(list.files(NAM_folder,full.names = T))==18){first24 <- c(7,8)} else 
  if(length(list.files(NAM_folder,full.names = T))==15){first24 <- c(5,6)} else {print("something went wrong"); next}
  for (j in 1:length(list.files(NAM_folder,full.names = T)[first24])) {
    # j <-1
    NAMfile <- list.files(NAM_folder,full.names = T)[j]
    # paste(NAM_folder,"/",NAMfile, sep = "") #don't need when full.names=T in list.dirs
    date_start <- str_locate_all(pattern ='_218_', NAMfile)[[1]][1,2] + 1
    storm_date <- as.numeric(substr(NAMfile,date_start,date_start+7))
    if(storm_date < 20060701){NAM_band <- 10} else if(storm_date > 20060701 && storm_date < 20170101){NAM_band <- 11} else {NAM_band <- 373}
    print(NAM_band)
    NAMlist[[i]][[j]] <- (raster(NAMfile, band=NAM_band) %>% projectRaster(crs = "+proj=longlat +datum=WGS84"))
    print(min(values(NAMlist[[i]][[j]]), na.rm=T))
    values(NAMlist[[i]][[j]])[which(values(NAMlist[[i]][[j]]<0))] <- 0 #change negative projected precipitation to 0
  }
  for (k in 1:length(list.files(ST4_folder,full.names = T)[1:4])) {
    # k <-1
    ST4file <- list.files(ST4_folder,full.names = T)[k]
    ST4list[[i]][[k]] <- (raster(ST4file) %>% projectRaster(crs = "+proj=longlat +datum=WGS84"))
    ST4list[[i]][[k]] <- resample(ST4list[[i]][[k]], mask.regrid, method = "bilinear")
    
    print(min(values(ST4list[[i]][[k]]), na.rm=T))
    values(ST4list[[i]][[k]])[which(values(ST4list[[i]][[k]]<0))] <- 0 #change negative projected precipitation to 0
  }
  first24NAM <- (NAMlist[[i]][[1]]+NAMlist[[i]][[2]])*mask.regrid
  first24ST4 <- (ST4list[[i]][[1]]+ST4list[[i]][[2]]+ST4list[[i]][[3]]+ST4list[[i]][[4]])*mask.regrid
  error.max <- max(abs(min(values(first24NAM-first24ST4),
                           na.rm = T)),max(values(first24NAM-first24ST4),na.rm = T))

  plot(first24NAM, xlim=c(-110,-55), ylim=c(23,50),
       main=paste(all.storm.folders[i],"NAM"));plot(st_geometry(spData::us_states), add=TRUE)
  plot(first24ST4, xlim=c(-110,-55), ylim=c(23,50),
       main=all.storm.folders[i]);plot(st_geometry(spData::us_states), add=TRUE)
  plot(first24NAM-first24ST4, breaks=seq(-1*ceiling(error.max/10)*10,ceiling(error.max/10)*10,ceiling(error.max/10)),
       xlim=c(-110,-55), ylim=c(23,50),col=colorspace::diverge_hsv(20),
       main="Error, Forecast NAM - Observed ST4")
  plot(st_geometry(spData::us_states), add=TRUE)
}
```